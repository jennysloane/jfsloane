---
authors:
- admin
date: "2021-08-17T00:00:00Z"
draft: false
featured: false
image: 
  caption: ""
  focal_point: ""
subtitle: 
summary: In this blog, I share my experience using an API for the first time
title: "My First API: Which NFL games should I watch?"
---

<script src="{{< blogdown/postref >}}index_files/header-attrs/header-attrs.js"></script>


<!-- have to knit first if .Rmd -->
<style type="text/css">

body {
  font-size: 14pt;
}

h1 { /* Header 1 */
  font-size: 34px;
  color: DarkBlue;
  font-weight: bold;
}

h2 { /* Header 2 */
    font-size: 30px;
    color: DarkBlue;
    font-weight: bold;
}

h3 { /* Header 2 */
  font-size: 26px;
  color: DarkBlue;
  font-weight: bold;
}

</style>
<p>
<p>Growing up in Baltimore MD, I‚Äôve been a <strong>huge</strong> Ravens fan for as long as I can remember. I‚Äôve always loved American football and I try to watch as many games as I can‚Ä¶ regardless of where I‚Äôm living in the world. The problem is there are just too many games to watch in any given week. Therefore, my goal for this project was to create a program that tells me the ‚Äútop‚Äù games of the week, depending on a criteria I‚Äôve created. So what‚Äôs my criteria?</p>
<ol style="list-style-type: decimal">
<li><strong>Favorite teams</strong>: Obviously <span style="color: MediumSlateBlue;">Baltimore Ravens!!</span> And <span style="color: Red;">Kansas City Chiefs</span> (for my partner)</li>
<li><strong>Close games</strong>: Final score within 5 points &amp; combine total score &gt; 35</li>
<li><strong>High scoring games</strong>: Total score &gt;= 40</li>
<li><strong>Multiple lead changes</strong>: At least 2 lead changes from quarter to quarter
</p></li>
</ol>
<div id="helpful-resources-on-apis" class="section level3">
<h3>Helpful resources on APIs</h3>
<ul>
<li>I won‚Äôt go into too much detail about APIs, but here are some resources I found particularly useful</li>
<li><a href="https://www.dataquest.io/blog/r-api-tutorial/">R API tutorial</a></li>
<li><a href="https://www.rstudio.com/resources/rstudioconf-2017/using-web-apis-from-r/">Using Web APIs from R</a></li>
</ul>
</div>
<div id="notes-before-getting-started" class="section level3">
<h3>Notes before getting started</h3>
<ul>
<li>I‚Äôll be using data from <a href="https://www.mysportsfeeds.com/">https://www.mysportsfeeds.com/</a></li>
<li>You need authorization to access this API, so only I can successfully run the code because I have the necessary credentials saved in a safe location on my computer</li>
<li>2 incredibly useful packages: <code>httr</code> and <code>jsonlite</code></li>
</ul>
</div>
<div id="load-libraries" class="section level3">
<h3>Load libraries</h3>
<pre class="r"><code>library(here)
library(tidyverse) 
library(janitor)
library(httr)
library(jsonlite)
library(RCurl)
library(kableExtra)
library(gt)
library(gmailr)
library(glue)
library(mysportsfeedsR)</code></pre>
</div>
<div id="set-parameters" class="section level3">
<h3>Set parameters</h3>
<ul>
<li>In this blog, I‚Äôll go through an example using 2021 pre-season week 1 data</li>
</ul>
<pre class="r"><code># for request
season = &quot;pre&quot; # &quot;pre&quot; or &quot;regular&quot;
n_week = 1 # week number

# for data cleaning
close_game_points = 5
close_game_points_total = 35
high_score_points = 40</code></pre>
</div>
<div id="get-request" class="section level3">
<h3>GET request</h3>
<ul>
<li><p>This was by far the most challenging part! It‚Äôs only a few lines of code, but it took me hours to figure out the formatting of everything</p></li>
<li><p>The API documentation from the website I‚Äôm using specifically says:</p>
<ol style="list-style-type: decimal">
<li>‚ÄúIssue a HTTPS GET request to: <code>https://api.mysportsfeeds.com/v2.1/pull/nfl/{season}/week/{week}/games.{format}</code>‚Äù</li>
<li>‚ÄúAuthorization: Basic {encrypted_api_key_credentials}‚Äù
<ul>
<li>{encrypted_api_key_credentials} = api_key_token + ‚Äú:‚Äù + password</li>
<li>and then encoding it with base64 encoding</li>
</ul></li>
</ol></li>
<li><p>The first couple of lines of code below are accessing and loading in my credentials and authorization keys<br />
</p></li>
<li><p>Then I use <code>httr::GET()</code> to send a request to the API</p></li>
<li><p>I use the <code>glue()</code> function to paste together my URL string that includes the parameters I‚Äôve set above</p></li>
<li><p>I also use the add_header argument to add the Authorization in the specific way the website has instructed</p>
<ul>
<li><em>Note: ‚Äúauth‚Äù is my API key token wrapped in the base64() function</em></li>
</ul></li>
<li><p>When we look at the response, we see the Status = 200 which is exactly what we want to see! This means the request has succeeded yay :smile:</p></li>
</ul>
<pre class="r"><code>setwd(here(&quot;../&quot;))
source(&quot;login_creds.R&quot;)

res = GET(glue(&#39;https://api.mysportsfeeds.com/v2.0/pull/nfl/2021-{season}/week/{n_week}/games.json&#39;), 
          add_headers(Authorization = paste(&quot;Basic&quot;, auth)))
res </code></pre>
<pre><code>## Response [https://api.mysportsfeeds.com/v2.0/pull/nfl/2021-pre/week/1/games.json]
##   Date: 2021-08-26 22:25
##   Status: 200
##   Content-Type: application/json
##   Size: 37.4 kB</code></pre>
<p>However, the response is an object that is not very R friendly so‚Ä¶</p>
<ul>
<li>First, I need to convert the response into a character and I‚Äôll use <code>httr::content()</code> to do this</li>
<li>Then, I need to convert the JSON object to an R object using <code>jsonlite::fromJSON()</code> (this function only accepts characters, which is why I used content() first)</li>
</ul>
<pre class="r"><code>api_response &lt;- content(res, as=&quot;text&quot;)
api_response &lt;- jsonlite::fromJSON(api_response, flatten=TRUE) # flatten=TRUE automatically flattens nested data into a single non-nested data frame

games_raw &lt;- api_response$games # selecting the data I want</code></pre>
</div>
<div id="github-repo" class="section level3">
<h3>Github Repo‚Ä¶</h3>
<p><a href="https://github.com/MySportsFeeds/mysportsfeeds-r">MySportsFeed Github R</a></p>
<p>Turns out, there‚Äôs already an entire Github repo that has a MySportsFeed R wrapper to make the process of getting the data from the API much easier. It‚Äôs always good to have a look on github first, especially for popular APIs!</p>
<ul>
<li>I actually used this method at first, but I wanted to learn how to get the data without a wrapper, so that‚Äôs why I‚Äôve included the code above and this is included but commented out</li>
<li>Install: devtools::install_github(‚ÄúMySportsFeeds/mysportsfeeds-r‚Äù)</li>
<li>Authenticate using api key</li>
<li>msf_get_results() to get a request for a specific feed and can specify parameters</li>
</ul>
<pre class="r"><code># authenticate_v2_x(auth2) # auth without base64()
# 
# weekly_games &lt;- msf_get_results(version=&#39;2.0&#39;,
#                                 league=&#39;nfl&#39;,
#                                 season=&#39;2021-pre&#39;,
#                                 feed=&#39;weekly_games&#39;,
#                                 params=list(week=1))
# 
# games_raw &lt;- weekly_games$api_json$games</code></pre>
</div>
<div id="clean-the-data" class="section level3">
<h3>Clean the data</h3>
<ul>
<li>Now I have the ‚Äúraw‚Äù data in R, but it definitely needs some cleaning</li>
<li>Check out the clean data below!</li>
</ul>
<pre class="r"><code>games_clean &lt;- games_raw %&gt;%
  as_tibble() %&gt;%
  clean_names() %&gt;%
  select(schedule_week, schedule_away_team_abbreviation, schedule_home_team_abbreviation, score_away_score_total, score_home_score_total, score_quarters) %&gt;%
  rename(away_team = schedule_away_team_abbreviation,
         home_team = schedule_home_team_abbreviation,
         away_score_final = score_away_score_total,
         home_score_final = score_home_score_total) %&gt;%
  unnest(score_quarters) %&gt;% # was a list with 3 variables before, this unnests the list
  mutate(final_score_diff = abs(away_score_final-home_score_final), 
         total_score_combine = away_score_final+home_score_final)

games_clean</code></pre>
<pre><code>## # A tibble: 64 x 10
##    schedule_week away_team home_team away_score_final home_score_final
##            &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;                &lt;int&gt;            &lt;int&gt;
##  1             1 WAS       NE                      13               22
##  2             1 WAS       NE                      13               22
##  3             1 WAS       NE                      13               22
##  4             1 WAS       NE                      13               22
##  5             1 PIT       PHI                     24               16
##  6             1 PIT       PHI                     24               16
##  7             1 PIT       PHI                     24               16
##  8             1 PIT       PHI                     24               16
##  9             1 TEN       ATL                     16                3
## 10             1 TEN       ATL                     16                3
## # ... with 54 more rows, and 5 more variables: quarterNumber &lt;int&gt;,
## #   awayScore &lt;int&gt;, homeScore &lt;int&gt;, final_score_diff &lt;int&gt;,
## #   total_score_combine &lt;int&gt;</code></pre>
</div>
<div id="deciding-which-games-to-watch" class="section level1">
<h1>Deciding which games to watch</h1>
<ul>
<li>I‚Äôm sure there‚Äôs a more efficient ways to do this, but I thought I‚Äôd keep it easy to follow by creating mini datasets that align with my initial criteria</li>
<li>Importantly, I don‚Äôt want to see any data that could potentially ruin the games for me - I just want to see the match ups of the games I want to watch (so the only data I want in the end is the away and home team names)</li>
</ul>
<pre class="r"><code>ravens_chiefs &lt;- games_clean %&gt;%
  filter(away_team %in% c(&quot;BAL&quot;, &quot;KC&quot;) | home_team %in% c(&quot;BAL&quot;, &quot;KC&quot;)) %&gt;%
  select(away_team, home_team)

close_games &lt;- games_clean %&gt;%
  filter(final_score_diff &lt;= close_game_points &amp; total_score_combine &gt; close_game_points_total) %&gt;%
  select(away_team, home_team)

high_games &lt;- games_clean %&gt;%
  filter(total_score_combine &gt;= high_score_points) %&gt;%
  select(away_team, home_team)
  
lead_change &lt;- games_clean %&gt;%
  select(away_team, home_team, quarterNumber, awayScore, homeScore) %&gt;%
  group_by(away_team, home_team) %&gt;%
  mutate(cum_away_score = cumsum(awayScore),
         cum_home_score = cumsum(homeScore)) %&gt;%
  mutate(q_score_diff = cum_away_score - cum_home_score, # negative means away team in the lead
         q_score_diff_sign = sign(q_score_diff)) %&gt;% # just makes it easier to read either + or - 1
  summarise(sign_diff_sum = sum(diff(sign(q_score_diff_sign)) != 0)) %&gt;% # how many sign changes are there with each game
  filter(sign_diff_sum &gt;= 2) %&gt;%
  select(away_team, home_team)

final_games &lt;- rbind(ravens_chiefs, close_games, high_games, lead_change) %&gt;%
  distinct(away_team, home_team)

final_games </code></pre>
<pre><code>## # A tibble: 6 x 2
##   away_team home_team
##   &lt;chr&gt;     &lt;chr&gt;    
## 1 NO        BAL      
## 2 KC        SF       
## 3 CAR       IND      
## 4 PIT       PHI      
## 5 LAC       LA       
## 6 WAS       NE</code></pre>
<div id="gmailr" class="section level3">
<h3>gmailr</h3>
<ul>
<li>Finally, I thought it would be cool to learn how to get these results emailed to myself‚Ä¶ why not learn one more thing, right?</li>
<li>Fortunately, I found the <code>gmailr</code> package</li>
<li>To do this, I decided to create a new email account because I had to adjust the security settings to ‚ÄúLess secure app access‚Äù which I didn‚Äôt want to do with my primary email</li>
<li>So now all I have to do is run the script and I‚Äôll get an email with all the games I should watch</li>
</ul>
<pre class="r"><code>games_table &lt;- final_games %&gt;%
  kable()

gm_auth_configure(key = key, secret = secret)

email_msg &lt;- glue(&quot;Here are your top NFL games to watch this week!! &lt;br&gt; {games_table} &lt;br&gt; &lt;b&gt;GO RAVENS&lt;/b&gt;&quot;)

my_html_msg &lt;- gm_mime() %&gt;%
  gm_to(c(&quot;j.sloane@unsw.edu.au&quot;)) %&gt;%
  gm_from(&quot;jsloane1992@gmail.com&quot;) %&gt;%
  gm_subject(&quot;NFL Games!&quot;) %&gt;%
  gm_html_body(email_msg)

gm_send_message(my_html_msg)</code></pre>
<ul>
<li>And finally‚Ä¶here‚Äôs a screenshot of my email!! üèà</li>
</ul>
<p><img src="images/email_results.png" /></p>
</div>
</div>
